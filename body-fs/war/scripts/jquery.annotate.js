(function(b){b.fn.annotateImage=function(a){a=b.extend({},b.fn.annotateImage.defaults,a);var c=this;this.image=this;this.mode="view";this.getUrl=a.getUrl;this.saveUrl=a.saveUrl;this.deleteUrl=a.deleteUrl;this.editable=a.editable;this.useAjax=a.useAjax;this.notes=a.notes;this.canvas=b('<div class="image-annotate-canvas"><div class="image-annotate-view"></div><div class="image-annotate-edit"><div class="image-annotate-edit-area"></div></div></div>');this.canvas.children(".image-annotate-edit").hide();
this.canvas.children(".image-annotate-view").hide();this.image.after(this.canvas);this.canvas.height(this.height());this.canvas.width(this.width());this.canvas.css("background-image",'url("'+this.attr("src")+'")');this.canvas.children(".image-annotate-view, .image-annotate-edit").height(this.height());this.canvas.children(".image-annotate-view, .image-annotate-edit").width(this.width());this.canvas.hover(function(){b(this).children(".image-annotate-edit").css("display")=="none"&&b(this).children(".image-annotate-view").show()},
function(){b(this).children(".image-annotate-view").hide()});this.canvas.children(".image-annotate-view").hover(function(){b(this).show()},function(){b(this).hide()});this.useAjax?b.fn.annotateImage.ajaxLoad(this):b.fn.annotateImage.load(this);if(this.editable){this.button=b('<a class="image-annotate-add" id="image-annotate-add" href="#">Add Note</a>');this.button.click(function(){b.fn.annotateImage.add(c)});this.canvas.after(this.button)}this.hide();return this};b.fn.annotateImage.defaults={getUrl:"your-get.rails",
saveUrl:"your-save.rails",deleteUrl:"your-delete.rails",editable:true,useAjax:true,notes:[]};b.fn.annotateImage.clear=function(a){for(var c=0;c<a.notes.length;c++)a.notes[a.notes[c]].destroy();a.notes=[]};b.fn.annotateImage.ajaxLoad=function(a){b.getJSON(a.getUrl+"?ticks="+b.fn.annotateImage.getTicks(),function(c){a.notes=c;b.fn.annotateImage.load(a)})};b.fn.annotateImage.load=function(a){for(var c=0;c<a.notes.length;c++)a.notes[a.notes[c]]=new b.fn.annotateView(a,a.notes[c])};b.fn.annotateImage.getTicks=
function(){var a=new Date;return a.getTime()};b.fn.annotateImage.add=function(a){if(a.mode=="view"){a.mode="edit";var c=new b.fn.annotateEdit(a);b.fn.annotateImage.createSaveButton(c,a);b.fn.annotateImage.createCancelButton(c,a)}};b.fn.annotateImage.createSaveButton=function(a,c,d){var e=b('<a class="image-annotate-edit-ok">OK</a>');e.click(function(){var f=b("#image-annotate-edit-form form"),g=b("#image-annotate-text").val();b.fn.annotateImage.appendPosition(f,a);c.mode="view";c.useAjax&&b.ajax({url:c.saveUrl,
data:f.serialize(),error:function(){alert("An error occured saving that note.")},success:function(h){if(h.annotation_id!=undefined)a.note.id=h.annotation_id},dataType:"json"});if(d)d.resetPosition(a,g);else{a.note.editable=true;d=new b.fn.annotateView(c,a.note);d.resetPosition(a,g);c.notes.push(a.note)}a.destroy()});a.form.append(e)};b.fn.annotateImage.createCancelButton=function(a,c){var d=b('<a class="image-annotate-edit-close">Cancel</a>');d.click(function(){a.destroy();c.mode="view"});a.form.append(d)};
b.fn.annotateImage.saveAsHtml=function(a,c){c=b(c);for(var d="",e=0;e<a.notes.length;e++){d+=b.fn.annotateImage.createHiddenField("text_"+e,a.notes[e].text);d+=b.fn.annotateImage.createHiddenField("top_"+e,a.notes[e].top);d+=b.fn.annotateImage.createHiddenField("left_"+e,a.notes[e].left);d+=b.fn.annotateImage.createHiddenField("height_"+e,a.notes[e].height);d+=b.fn.annotateImage.createHiddenField("width_"+e,a.notes[e].width)}c.html(d)};b.fn.annotateImage.createHiddenField=function(a,c){return'&lt;input type="hidden" name="'+
a+'" value="'+c+'" /&gt;<br />'};b.fn.annotateEdit=function(a,c){this.image=a;if(c)this.note=c;else{c={};c.id="new";c.top=30;c.left=30;c.width=30;c.height=30;c.text="";this.note=c}var d=a.canvas.children(".image-annotate-edit").children(".image-annotate-edit-area");this.area=d;this.area.css("height",this.note.height+"px");this.area.css("width",this.note.width+"px");this.area.css("left",this.note.left+"px");this.area.css("top",this.note.top+"px");a.canvas.children(".image-annotate-view").hide();a.canvas.children(".image-annotate-edit").show();
var e=b('<div id="image-annotate-edit-form"><form><textarea id="image-annotate-text" name="text" rows="3" cols="30">'+this.note.text+"</textarea></form></div>");this.form=e;b("body").append(this.form);this.form.css("left",this.area.offset().left+"px");this.form.css("top",parseInt(this.area.offset().top)+parseInt(this.area.height())+7+"px");d.resizable({handles:"all",stop:function(){e.css("left",d.offset().left+"px");e.css("top",parseInt(d.offset().top)+parseInt(d.height())+2+"px")}}).draggable({containment:a.canvas,
drag:function(){e.css("left",d.offset().left+"px");e.css("top",parseInt(d.offset().top)+parseInt(d.height())+2+"px")},stop:function(){e.css("left",d.offset().left+"px");e.css("top",parseInt(d.offset().top)+parseInt(d.height())+2+"px")}});return this};b.fn.annotateEdit.prototype.destroy=function(){this.image.canvas.children(".image-annotate-edit").hide();this.area.resizable("destroy");this.area.draggable("destroy");this.area.css("height","");this.area.css("width","");this.area.css("left","");this.area.css("top",
"");this.form.remove()};b.fn.annotateView=function(a,c){this.image=a;this.note=c;this.editable=c.editable&&a.editable;this.area=b('<div class="image-annotate-area'+(this.editable?" image-annotate-area-editable":"")+'"><div></div></div>');a.canvas.children(".image-annotate-view").prepend(this.area);this.form=b('<div class="image-annotate-note">'+c.text+"</div>");this.form.hide();a.canvas.children(".image-annotate-view").append(this.form);this.form.children("span.actions").hide();this.setPosition();
var d=this;this.area.hover(function(){d.show()},function(){d.hide()});if(this.editable){var e=this;this.area.click(function(){e.edit()})}};b.fn.annotateView.prototype.setPosition=function(){this.area.children("div").height(parseInt(this.note.height)-2+"px");this.area.children("div").width(parseInt(this.note.width)-2+"px");this.area.css("left",this.note.left+"px");this.area.css("top",this.note.top+"px");this.form.css("left",this.note.left+"px");this.form.css("top",parseInt(this.note.top)+parseInt(this.note.height)+
7+"px")};b.fn.annotateView.prototype.show=function(){this.form.fadeIn(250);this.editable?this.area.addClass("image-annotate-area-editable-hover"):this.area.addClass("image-annotate-area-hover")};b.fn.annotateView.prototype.hide=function(){this.form.fadeOut(250);this.area.removeClass("image-annotate-area-hover");this.area.removeClass("image-annotate-area-editable-hover")};b.fn.annotateView.prototype.destroy=function(){this.area.remove();this.form.remove()};b.fn.annotateView.prototype.edit=function(){if(this.image.mode==
"view"){this.image.mode="edit";var a=this,c=new b.fn.annotateEdit(this.image,this.note);b.fn.annotateImage.createSaveButton(c,this.image,a);var d=b('<a class="image-annotate-edit-delete">Delete</a>');d.click(function(){var e=b("#image-annotate-edit-form form");b.fn.annotateImage.appendPosition(e,c);a.image.useAjax&&b.ajax({url:a.image.deleteUrl,data:e.serialize(),error:function(){alert("An error occured deleting that note.")}});a.image.mode="view";c.destroy();a.destroy()});c.form.append(d);b.fn.annotateImage.createCancelButton(c,
this.image)}};b.fn.annotateImage.appendPosition=function(a,c){c=b('<input type="hidden" value="'+c.area.height()+'" name="height"/><input type="hidden" value="'+c.area.width()+'" name="width"/><input type="hidden" value="'+c.area.position().top+'" name="top"/><input type="hidden" value="'+c.area.position().left+'" name="left"/><input type="hidden" value="'+c.note.id+'" name="id"/>');a.append(c)};b.fn.annotateView.prototype.resetPosition=function(a,c){this.form.html(c);this.form.hide();this.area.children("div").height(a.area.height()+
"px");this.area.children("div").width(a.area.width()-2+"px");this.area.css("left",a.area.position().left+"px");this.area.css("top",a.area.position().top+"px");this.form.css("left",a.area.position().left+"px");this.form.css("top",parseInt(a.area.position().top)+parseInt(a.area.height())+7+"px");this.note.top=a.area.position().top;this.note.left=a.area.position().left;this.note.height=a.area.height();this.note.width=a.area.width();this.note.text=c;this.note.id=a.note.id;this.editable=true}})(jQuery);